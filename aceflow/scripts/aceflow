#!/usr/bin/env python3
"""
AceFlow v3.0 CLI å·¥å…·
ä¸»è¦åŠŸèƒ½ï¼šé¡¹ç›®ç®¡ç†ã€æµç¨‹æ§åˆ¶ã€AIè¾…åŠ©
"""

import json
import os
import sys
import argparse
import yaml
from datetime import datetime
from pathlib import Path

class AceFlowCLI:
    def __init__(self):
        self.project_root = Path.cwd()
        self.aceflow_dir = self.project_root / ".aceflow"
        self.state_file = self.aceflow_dir / "state" / "project_state.json"
        self.config_file = self.aceflow_dir / "config" / "project.yaml"
    
    def load_state(self):
        """åŠ è½½é¡¹ç›®çŠ¶æ€"""
        if self.state_file.exists():
            with open(self.state_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return {}
    
    def save_state(self, state):
        """ä¿å­˜é¡¹ç›®çŠ¶æ€"""
        state['last_updated'] = datetime.now().isoformat()
        with open(self.state_file, 'w', encoding='utf-8') as f:
            json.dump(state, f, indent=2, ensure_ascii=False)
    
    def load_config(self):
        """åŠ è½½é¡¹ç›®é…ç½®"""
        if self.config_file.exists():
            with open(self.config_file, 'r', encoding='utf-8') as f:
                return yaml.safe_load(f)
        return {}
    
    def init_project(self, mode='smart'):
        """åˆå§‹åŒ– AceFlow é¡¹ç›®"""
        print(f"ğŸš€ åˆå§‹åŒ– AceFlow v3.0 é¡¹ç›®...")
        
        # åˆ›å»ºç›®å½•ç»“æ„
        dirs = [
            '.aceflow/config',
            '.aceflow/state',
            '.aceflow/scripts',
            '.aceflow/templates',
            '.aceflow/memory',
            'aceflow_result'
        ]
        
        for dir_path in dirs:
            os.makedirs(dir_path, exist_ok=True)
        
        # åˆå§‹åŒ–çŠ¶æ€
        state = {
            "project_id": f"aceflow_{datetime.now().strftime('%Y%m%d_%H%M%S')}",
            "flow_mode": mode,
            "selected_mode": None,
            "current_stage": None,
            "overall_progress": 0,
            "created_at": datetime.now().isoformat(),
            "version": "3.0.0"
        }
        
        self.save_state(state)
        print(f"âœ… AceFlow é¡¹ç›®åˆå§‹åŒ–å®Œæˆï¼æ¨¡å¼: {mode}")
        return state
    
    def status(self, format_type='text', verbose=False):
        """æŸ¥çœ‹é¡¹ç›®çŠ¶æ€"""
        if not self.aceflow_dir.exists():
            print("âŒ æœªæ£€æµ‹åˆ° AceFlow é¡¹ç›®ï¼Œè¯·å…ˆè¿è¡Œ 'aceflow init'")
            return
        
        state = self.load_state()
        config = self.load_config()
        
        if format_type == 'json':
            print(json.dumps(state, indent=2, ensure_ascii=False))
        else:
            self._print_status_text(state, config, verbose)
    
    def _print_status_text(self, state, config, verbose):
        """æ‰“å°æ–‡æœ¬æ ¼å¼çš„çŠ¶æ€"""
        print("\nğŸ“Š AceFlow é¡¹ç›®çŠ¶æ€")
        print("=" * 40)
        print(f"é¡¹ç›®ID: {state.get('project_id', 'N/A')}")
        print(f"æµç¨‹æ¨¡å¼: {state.get('flow_mode', 'N/A')}")
        print(f"å½“å‰é˜¶æ®µ: {state.get('current_stage', 'æœªå¼€å§‹')}")
        print(f"æ•´ä½“è¿›åº¦: {state.get('overall_progress', 0)}%")
        print(f"æœ€åæ›´æ–°: {state.get('last_updated', 'N/A')}")
        
        if verbose:
            print(f"\nğŸ“‹ è¯¦ç»†ä¿¡æ¯:")
            print(f"ç‰ˆæœ¬: {state.get('version', 'N/A')}")
            print(f"åˆ›å»ºæ—¶é—´: {state.get('created_at', 'N/A')}")
            print(f"é…ç½®æ–‡ä»¶: {self.config_file}")
            print(f"çŠ¶æ€æ–‡ä»¶: {self.state_file}")
    
    def analyze(self, task_description):
        """AI ä»»åŠ¡åˆ†æ"""
        print(f"ğŸ§  æ­£åœ¨åˆ†æä»»åŠ¡: {task_description}")
        
        # ç®€å•çš„ä»»åŠ¡åˆ†ç±»é€»è¾‘
        keywords = {
            'bug': ['ä¿®å¤', 'fix', 'bug', 'é—®é¢˜', 'é”™è¯¯'],
            'feature': ['æ–°åŠŸèƒ½', 'å¼€å‘', 'å®ç°', 'æ·»åŠ ', 'åŠŸèƒ½'],
            'refactor': ['é‡æ„', 'ä¼˜åŒ–', 'æ”¹è¿›', 'é‡å†™'],
            'project': ['é¡¹ç›®', 'ç³»ç»Ÿ', 'å¹³å°', 'æ¶æ„']
        }
        
        task_type = 'unknown'
        for category, kw_list in keywords.items():
            if any(kw in task_description.lower() for kw in kw_list):
                task_type = category
                break
        
        # æ¨èæ¨¡å¼
        mode_mapping = {
            'bug': 'minimal',
            'feature': 'standard',
            'refactor': 'standard',
            'project': 'complete',
            'unknown': 'smart'
        }
        
        recommended_mode = mode_mapping.get(task_type, 'smart')
        
        result = {
            'task_description': task_description,
            'task_type': task_type,
            'recommended_mode': recommended_mode,
            'confidence': 0.85,
            'analysis_time': datetime.now().isoformat()
        }
        
        print(f"ğŸ“Š åˆ†æç»“æœ:")
        print(f"  ä»»åŠ¡ç±»å‹: {task_type}")
        print(f"  æ¨èæ¨¡å¼: {recommended_mode}")
        print(f"  ç½®ä¿¡åº¦: 85%")
        
        return result
    
    def start(self, description=None, mode=None):
        """å¼€å§‹æ–°çš„å·¥ä½œæµ"""
        state = self.load_state()
        
        if not description:
            description = input("è¯·æè¿°æ‚¨è¦å¼€å§‹çš„ä»»åŠ¡: ")
        
        if not mode:
            # æ™ºèƒ½åˆ†ææ¨èæ¨¡å¼
            analysis = self.analyze(description)
            mode = analysis['recommended_mode']
        
        # ç”Ÿæˆè¿­ä»£ID
        iteration_id = f"iter_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        # æ›´æ–°çŠ¶æ€
        state.update({
            'selected_mode': mode,
            'current_stage': self._get_first_stage(mode),
            'iteration_id': iteration_id,
            'task_description': description,
            'overall_progress': 0,
            'stage_progress': 0
        })
        
        self.save_state(state)
        
        # åˆ›å»ºç»“æœç›®å½•
        result_dir = Path(f"aceflow_result/{iteration_id}")
        result_dir.mkdir(parents=True, exist_ok=True)
        
        print(f"ğŸš€ å¼€å§‹ AceFlow å·¥ä½œæµ")
        print(f"  ä»»åŠ¡æè¿°: {description}")
        print(f"  é€‰æ‹©æ¨¡å¼: {mode}")
        print(f"  è¿­ä»£ID: {iteration_id}")
        print(f"  å½“å‰é˜¶æ®µ: {state['current_stage']}")
        print(f"  ç»“æœç›®å½•: {result_dir}")
        
        return state
    
    def _get_first_stage(self, mode):
        """è·å–æ¨¡å¼çš„ç¬¬ä¸€ä¸ªé˜¶æ®µ"""
        stage_mapping = {
            'minimal': 'P',
            'standard': 'P1',
            'complete': 'S1',
            'smart': 'S1'
        }
        return stage_mapping.get(mode, 'S1')
    
    def progress(self, stage, percentage):
        """æ›´æ–°è¿›åº¦"""
        state = self.load_state()
        
        if stage == 'current':
            stage = state.get('current_stage')
        
        if not stage:
            print("âŒ æœªæ‰¾åˆ°å½“å‰é˜¶æ®µ")
            return
        
        state['stage_progress'] = percentage
        # ç®€å•çš„æ•´ä½“è¿›åº¦è®¡ç®—
        state['overall_progress'] = min(percentage, 100)
        
        self.save_state(state)
        
        print(f"ğŸ“ˆ è¿›åº¦æ›´æ–°: {stage} -> {percentage}%")
        return state
    
    def complete(self, stage=None):
        """å®Œæˆé˜¶æ®µ"""
        state = self.load_state()
        
        if not stage:
            stage = state.get('current_stage')
        
        if not stage:
            print("âŒ æœªæ‰¾åˆ°å½“å‰é˜¶æ®µ")
            return
        
        print(f"âœ… å®Œæˆé˜¶æ®µ: {stage}")
        
        # æ›´æ–°çŠ¶æ€
        state['stage_progress'] = 100
        
        # ç§»åŠ¨åˆ°ä¸‹ä¸€é˜¶æ®µ
        next_stage = self._get_next_stage(stage, state.get('selected_mode'))
        if next_stage:
            state['current_stage'] = next_stage
            state['stage_progress'] = 0
            print(f"â¡ï¸  è¿›å…¥ä¸‹ä¸€é˜¶æ®µ: {next_stage}")
        else:
            print("ğŸ‰ æ‰€æœ‰é˜¶æ®µå®Œæˆï¼")
            state['current_stage'] = None
            state['overall_progress'] = 100
        
        self.save_state(state)
        return state
    
    def _get_next_stage(self, current_stage, mode):
        """è·å–ä¸‹ä¸€ä¸ªé˜¶æ®µ"""
        stage_flows = {
            'minimal': ['P', 'D', 'R'],
            'standard': ['P1', 'P2', 'D1', 'D2', 'R1'],
            'complete': ['S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'],
            'smart': ['S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8']
        }
        
        flow = stage_flows.get(mode, [])
        if current_stage in flow:
            current_index = flow.index(current_stage)
            if current_index + 1 < len(flow):
                return flow[current_index + 1]
        
        return None

def main():
    parser = argparse.ArgumentParser(description='AceFlow v3.0 CLI å·¥å…·')
    subparsers = parser.add_subparsers(dest='command', help='å¯ç”¨å‘½ä»¤')
    
    # init å‘½ä»¤
    init_parser = subparsers.add_parser('init', help='åˆå§‹åŒ–é¡¹ç›®')
    init_parser.add_argument('--mode', choices=['smart', 'minimal', 'standard', 'complete'], 
                           default='smart', help='æµç¨‹æ¨¡å¼')
    
    # status å‘½ä»¤
    status_parser = subparsers.add_parser('status', help='æŸ¥çœ‹çŠ¶æ€')
    status_parser.add_argument('--format', choices=['text', 'json'], default='text', help='è¾“å‡ºæ ¼å¼')
    status_parser.add_argument('--verbose', action='store_true', help='è¯¦ç»†è¾“å‡º')
    
    # analyze å‘½ä»¤
    analyze_parser = subparsers.add_parser('analyze', help='åˆ†æä»»åŠ¡')
    analyze_parser.add_argument('task', help='ä»»åŠ¡æè¿°')
    
    # start å‘½ä»¤
    start_parser = subparsers.add_parser('start', help='å¼€å§‹å·¥ä½œæµ')
    start_parser.add_argument('--description', help='ä»»åŠ¡æè¿°')
    start_parser.add_argument('--mode', choices=['smart', 'minimal', 'standard', 'complete'], 
                            help='æµç¨‹æ¨¡å¼')
    
    # progress å‘½ä»¤
    progress_parser = subparsers.add_parser('progress', help='æ›´æ–°è¿›åº¦')
    progress_parser.add_argument('stage', help='é˜¶æ®µåç§°')
    progress_parser.add_argument('percentage', type=int, help='è¿›åº¦ç™¾åˆ†æ¯”')
    
    # complete å‘½ä»¤
    complete_parser = subparsers.add_parser('complete', help='å®Œæˆé˜¶æ®µ')
    complete_parser.add_argument('stage', nargs='?', default='current', help='é˜¶æ®µåç§°')
    
    args = parser.parse_args()
    
    cli = AceFlowCLI()
    
    if args.command == 'init':
        cli.init_project(args.mode)
    elif args.command == 'status':
        cli.status(args.format, args.verbose)
    elif args.command == 'analyze':
        cli.analyze(args.task)
    elif args.command == 'start':
        cli.start(args.description, args.mode)
    elif args.command == 'progress':
        cli.progress(args.stage, args.percentage)
    elif args.command == 'complete':
        cli.complete(args.stage)
    else:
        parser.print_help()

if __name__ == '__main__':
    main()